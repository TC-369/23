<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Malla Curricular Mejorada</title>
  <style>
    body {
      background: #f5f5f5;
      font-family: Arial, sans-serif;
      color: #111;
      transition: background-image 0.5s;
      background-size: cover;
      background-position: center;
    }
    .titulo-editable {
      text-align: center;
      font-size: 2em;
      font-weight: bold;
      margin: 22px 0 18px 0;
      position: relative;
      color: #222;
    }
    .titulo-editable input {
      font-size: 1.15em;
      font-weight: bold;
      text-align: center;
      border: none;
      border-bottom: 1.5px solid #888;
      outline: none;
      background: #fff6;
      margin-bottom: 6px;
      padding: 4px 2px;
      width: 70vw;
      max-width: 600px;
    }
    .bg-controls {
      margin: 0 auto 18px auto;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      align-items: center;
    }
    .bg-controls label { font-weight: bold; }
    .bg-controls input[type="text"] {
      width: 280px;
      max-width: 55vw;
      padding: 4px;
      border-radius: 5px;
      border: 1px solid #888;
    }
    .bg-controls input[type="file"] {
      border: none;
    }
    .bg-controls button {
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 4px;
      padding: 4px 10px;
      font-size: 1em;
      cursor: pointer;
      transition: background .2s;
    }
    .bg-controls button:hover { background: #eee; }
    .acciones-malla {
      margin: 15px 0 10px 0;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .malla {
      display: grid;
      grid-gap: 10px;
      margin: 30px auto;
      max-width: 1200px;
      min-width: 320px;
      background: #e8e8e8;
      border-radius: 12px;
      padding: 18px 8px 18px 8px;
      border: 2px solid #bbb;
    }
    .anio-header {
      background: #cfcfcf;
      text-align: center;
      padding: 11px 0 10px 0;
      font-size: 1.1em;
      font-weight: bold;
      border-radius: 9px 9px 0 0;
      color: #111;
      min-width: 120px;
      min-height: 30px;
      letter-spacing: 1px;
      box-shadow: 0 2px 6px #0001;
      border: 2px solid #888;
      border-bottom: none;
    }
    .anio-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      min-width: 150px;
      max-width: 190px;
    }
    .materia {
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 110px;
      width: 98%;
      margin: 0 auto;
      border-radius: 13px;
      background-size: cover;
      background-position: center;
      background-blend-mode: lighten;
      background-repeat: no-repeat;
      border: 3px solid #888;
      box-shadow: 0 2px 12px #0001;
      cursor: pointer;
      transition: box-shadow 0.2s, border 0.2s, filter 0.2s;
      color: #111;
      overflow: hidden;
      z-index: 1;
      background-color: #fff;
    }
    .materia:hover {
      box-shadow: 0 0 18px #8886;
      border-color: #333;
      filter: brightness(0.96);
      z-index: 3;
    }
    .materia .codigo {
      font-size: 0.8em;
      font-weight: normal;
      color: #666;
      position: absolute;
      top: 9px;
      left: 12px;
      opacity: 0.7;
      letter-spacing: 0.5px;
      z-index: 2;
    }
    .materia .nombre {
      font-size: 1.1em;
      font-weight: bold;
      text-align: center;
      margin: 0 auto;
      margin-top: 18px;
      margin-bottom: 12px;
      width: 90%;
      z-index: 2;
      color: #111;
      letter-spacing: 0.4px;
    }
    .materia .creditos {
      position: absolute;
      bottom: 10px;
      right: 15px;
      background: #fffde7;
      color: #111;
      border-radius: 50%;
      width: 22px;
      height: 22px;
      font-size: 0.95em;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #bdbdbd;
      box-shadow: 0 1px 3px #0002;
      opacity: 0.9;
      z-index: 2;
    }
    .materia .checkbox-aprobada {
      position: absolute;
      left: 12px;
      bottom: 13px;
      font-size: 1.2em;
      z-index: 2;
    }
    .materia.aprobada {
      text-decoration: line-through;
      filter: grayscale(0.5) brightness(1.12) opacity(0.8);
      border-style: dashed;
    }
    .materia.inhabilitada {
      opacity: 0.42;
      filter: grayscale(0.7);
      pointer-events: none;
    }
    .materia .tooltip-correlativas {
      display: none;
      position: absolute;
      left: 50%; top: 3px;
      transform: translate(-50%, -110%);
      background: #333e;
      color: #fff;
      font-size: 0.91em;
      padding: 7px 15px;
      border-radius: 8px;
      z-index: 10;
      white-space: pre-line;
      min-width: 160px;
      text-align: center;
      pointer-events: none;
      font-weight: normal;
    }
    .materia:hover .tooltip-correlativas {
      display: block;
    }
    .materia .bg-imagen {
      position: absolute;
      left:0;top:0;width:100%;height:100%;
      opacity: 0.18;
      z-index: 0;
      border-radius: 10px;
      object-fit: cover;
    }
    .materia .acciones {
      position: absolute;
      top: 8px;
      right: 11px;
      z-index: 3;
      display: flex;
      gap: 4px;
    }
    .materia .acciones button {
      background: #fff;
      border: 1px solid #bbb;
      border-radius: 4px;
      font-size: 0.8em;
      padding: 2px 7px;
      cursor: pointer;
      opacity: 0.7;
      transition: background 0.2s;
    }
    .materia .acciones button:hover { opacity: 1; background: #eee;}
    .agregar-mat-btn {
      width: 98%;
      height: 48px;
      margin: 3px auto 3px auto;
      border: 2px dashed #bbb;
      border-radius: 10px;
      background: #f9f9f9;
      color: #888;
      font-size: 1.7em;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: border 0.2s, background 0.2s, color 0.2s;
    }
    .agregar-mat-btn:hover {
      border-color: #333;
      background: #e8e8e8;
      color: #333;
    }
    .editor-modal {
      position: fixed;
      top: 0; left: 0; width: 100vw; height: 100vh;
      background: #0008;
      display: flex; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .editor-content {
      background: #fff;
      color: #111;
      padding: 25px 18px;
      border-radius: 10px;
      min-width: 320px;
      box-shadow: 0 0 14px #0004;
      max-width: 95vw;
      max-height: 95vh;
      overflow: auto;
    }
    .editor-content label { font-weight: bold; }
    .editor-content input, .editor-content select, .editor-content textarea {
      font-size: 1em;
      margin-bottom: 12px;
      width: 100%;
      padding: 5px;
      border-radius: 4px;
      border: 1px solid #bbb;
    }
    .editor-content .botonera {
      display: flex; gap: 10px; justify-content: flex-end;
      margin-top: 10px;
    }
    @media (max-width: 900px) {
      .malla { min-width: 0; max-width: 100vw; grid-template-columns: repeat(2, 1fr);}
      .anio-header { font-size: 1em; }
    }
  </style>
</head>
<body>
  <div class="titulo-editable">
    <span id="titulo-malla" onclick="editarTitulo()" style="cursor:pointer;">Malla Curricular Mejorada</span>
    <input id="titulo-input" style="display:none;" maxlength="80">
  </div>
  <div class="bg-controls">
    <label>Imagen de fondo:</label>
    <input type="file" id="bg-file" accept="image/*">
    <span>ó URL:</span>
    <input type="text" id="bg-url" placeholder="https://...jpg">
    <button onclick="aplicarFondo()">Aplicar</button>
    <button onclick="quitarFondo()">Sin fondo</button>
  </div>
  <div style="max-width:1200px;margin:auto;">
    <div class="acciones-malla">
      <input type="button" value="Agregar Año" onclick="agregarAnio()">
      <input type="button" value="Agregar Materia" onclick="agregarMateriaGeneral()">
      <input type="button" value="Ver/Editar Categorías" onclick="abrirCategoriaEditor()">
      <input type="button" value="Resetear Estado" onclick="resetAprobadas()">
    </div>
    <div class="malla" id="malla"></div>
  </div>
  <!-- Modal para editar o agregar materias -->
  <div id="materia-modal" class="editor-modal" style="display:none;">
    <div class="editor-content">
      <form id="materia-form" onsubmit="guardarMateria(event)">
        <input type="hidden" id="materia-idx">
        <label>Código:</label>
        <input type="text" id="mat-codigo" required>
        <label>Nombre:</label>
        <input type="text" id="mat-nombre" required>
        <label>Créditos:</label>
        <input type="number" id="mat-creditos" min="1" required>
        <label>Año:</label>
        <select id="mat-anio"></select>
        <label>Categoría:</label>
        <select id="mat-categoria"></select>
        <label>Correlativas (códigos separados por coma):</label>
        <input type="text" id="mat-correlativas" placeholder="Ej: MAT021,FIS100">
        <label>Imagen de fondo (URL completa, opcional):</label>
        <input type="text" id="mat-bgimg" placeholder="https://...jpg">
        <div class="botonera">
          <button type="submit">Guardar</button>
          <button type="button" onclick="cerrarMateriaEditor()">Cancelar</button>
          <button type="button" id="btn-borrar-materia" style="display:none;" onclick="borrarMateria()">Eliminar</button>
        </div>
      </form>
    </div>
  </div>
  <!-- Modal para editar categorías -->
  <div id="categoria-modal" class="editor-modal" style="display:none;">
    <div class="editor-content" id="categorias-editor"></div>
  </div>
  <script>
    // --- ESTADO ---
    let categorias = {
      "Básica": "#fff9c4",
      "Matemática": "#ffe0b2",
      "Física": "#b2ebf2",
      "Ingeniería": "#c8e6c9",
      "Optativo": "#f8bbd0",
      "Humanista": "#d7ccc8",
      "Idioma": "#d1c4e9",
      "Otro": "#ffcdd2"
    };
    let anios = ["Año 1","Año 2","Año 3","Año 4","Año 5","Año 6"];
    let materias = [
      [1, "IVI1131", "Programación", 5, "Básica", [], ""],
      [1, "QUI010", "Química y Sociedad", 5, "Básica", [], ""],
      [2, "MAT035", "Probabilidad y Estadística", 7, "Matemática", ["MAT021"], ""],
      [3, "MEC220", "Mecánica de Fluidos Avanzadas", 5, "Ingeniería", ["MAT035"], ""],
      [4, "MEC373", "Automatización y Neumática", 5, "Ingeniería", ["MEC220"], ""],
      [5, "MEC397", "Seminario de Titulación", 13, "Ingeniería", ["MEC373"], ""],
      [1, "MAT021", "Matemáticas I", 8, "Matemática", [], ""],
      [1, "MAT022", "Matemáticas II", 8, "Matemática", [], ""],
      [2, "FIS140", "Física General IV", 5, "Física", ["QUI010"], ""],
      [3, "MEC353", "Mecánica de Máquinas", 5, "Ingeniería", ["MEC220"], ""],
      [4, "MEC382", "Ingeniería del Mantenimiento", 5, "Ingeniería", ["MEC373"], ""],
      [6, "MEC5", "Electivo 5", 5, "Optativo", [], ""]
    ];
    let aprobadas = {};

    // --- LOCALSTORAGE ---
    function guardarEstado() {
      localStorage.setItem('malla_materias', JSON.stringify(materias));
      localStorage.setItem('malla_titulo', document.getElementById('titulo-malla').textContent);
      localStorage.setItem('malla_bg_url', document.body.style.backgroundImage);
      localStorage.setItem('malla_anios', JSON.stringify(anios));
      localStorage.setItem('malla_aprobadas', JSON.stringify(aprobadas));
      localStorage.setItem('malla_categorias', JSON.stringify(categorias));
    }
    function cargarEstado() {
      let mallas = localStorage.getItem('malla_materias');
      if (mallas) materias = JSON.parse(mallas);
      let titulo = localStorage.getItem('malla_titulo');
      if (titulo) document.getElementById('titulo-malla').textContent = titulo;
      let fondo = localStorage.getItem('malla_bg_url');
      if (fondo) document.body.style.backgroundImage = fondo;
      let aniosLS = localStorage.getItem('malla_anios');
      if (aniosLS) anios = JSON.parse(aniosLS);
      let aprobadasLS = localStorage.getItem('malla_aprobadas');
      if (aprobadasLS) aprobadas = JSON.parse(aprobadasLS);
      let catsLS = localStorage.getItem('malla_categorias');
      if (catsLS) categorias = JSON.parse(catsLS);
      renderMalla();
    }
    function guardarYActualizar() {
      guardarEstado();
      renderMalla();
    }

    // --- MALLA ---
    function renderMalla() {
      const malla = document.getElementById('malla');
      malla.innerHTML = "";
      malla.style.gridTemplateColumns = `repeat(${anios.length}, 1fr)`;
      // Encabezado por año
      for (let a = 0; a < anios.length; a++) {
        const div = document.createElement('div');
        div.className = 'anio-header';
        div.textContent = anios[a];
        malla.appendChild(div);
      }
      let maxMaterias = 10;
      for (let fila = 0; fila < maxMaterias; fila++) {
        for (let a = 0; a < anios.length; a++) {
          let mats = materias.filter(m => m[0] === (a+1));
          let mat = mats[fila];
          if (mat) {
            const div = document.createElement('div');
            div.className = 'materia';
            div.style.background = categorias[mat[4]] || "#e0e0e0";
            if (mat[6]) {
              div.style.backgroundImage = mat[6] ? `url('${mat[6]}')` : "none";
            }
            if (aprobadas[mat[1]]) div.classList.add("aprobada");
            let habilitada = correlativasHabilitadas(mat);
            if (!habilitada) div.classList.add("inhabilitada");
            let correlTip = "";
            if (mat[5]&&mat[5].length) {
              correlTip = "Correlativas:\n" + mat[5].join(", ");
            } else {
              correlTip = "Sin correlativas";
            }
            div.innerHTML = `
              <div class="acciones">
                <button title="Editar" onclick="abrirMateriaEditor(${materias.indexOf(mat)});event.stopPropagation();">✏️</button>
              </div>
              <span class="codigo">${mat[1]}</span>
              <div class="nombre">${mat[2]}</div>
              <span class="creditos">${mat[3]}</span>
              <label class="checkbox-aprobada" title="Aprobar materia">
                <input type="checkbox" onchange="toggleAprobada('${mat[1]}')" ${aprobadas[mat[1]]?"checked":""}
                  ${!habilitada?"disabled":""}>
                ✔
              </label>
              <div class="tooltip-correlativas">${correlTip}</div>
            `;
            if (mat[6]) {
              let img = document.createElement("img");
              img.className = "bg-imagen";
              img.src = mat[6];
              img.alt = "";
              div.appendChild(img);
            }
            malla.appendChild(div);
          } else {
            const div = document.createElement('div');
            div.className = "agregar-mat-btn";
            div.innerHTML = '<span title="Agregar materia" onclick="abrirMateriaEditor(null,'+(a+1)+')">+</span>';
            div.onclick = (ev) => { abrirMateriaEditor(null, a+1); };
            malla.appendChild(div);
          }
        }
      }
    }

    // --- CORRELATIVAS ---
    function correlativasHabilitadas(mat) {
      if (!mat[5] || !mat[5].length) return true;
      return mat[5].every(cod => aprobadas[cod]);
    }
    function toggleAprobada(codigo) {
      aprobadas[codigo] = !aprobadas[codigo];
      guardarYActualizar();
    }
    function resetAprobadas() {
      aprobadas = {};
      guardarYActualizar();
    }

    // --- MODAL DE MATERIAS ---
    function abrirMateriaEditor(idx=null, anioSel=null) {
      document.getElementById('materia-modal').style.display = "";
      let sa = document.getElementById('mat-anio');
      sa.innerHTML = "";
      for(let i=0;i<anios.length;i++){
        let opt = document.createElement('option');
        opt.value = i+1; opt.textContent = anios[i];
        sa.appendChild(opt);
      }
      let sc = document.getElementById('mat-categoria');
      sc.innerHTML = "";
      Object.keys(categorias).forEach(cat=>{
        let opt = document.createElement('option');
        opt.value=cat; opt.textContent=cat;
        sc.appendChild(opt);
      });
      if(idx!==null){
        let m = materias[idx];
        document.getElementById('materia-idx').value = idx;
        document.getElementById('mat-codigo').value = m[1];
        document.getElementById('mat-nombre').value = m[2];
        document.getElementById('mat-creditos').value = m[3];
        sa.value = m[0];
        sc.value = m[4];
        document.getElementById('mat-correlativas').value = m[5]?m[5].join(","):"";
        document.getElementById('mat-bgimg').value = m[6]||"";
        document.getElementById('btn-borrar-materia').style.display = "";
      } else {
        document.getElementById('materia-idx').value = "";
        document.getElementById('mat-codigo').value = "";
        document.getElementById('mat-nombre').value = "";
        document.getElementById('mat-creditos').value = 5;
        sa.value = anioSel || 1;
        sc.value = Object.keys(categorias)[0];
        document.getElementById('mat-correlativas').value = "";
        document.getElementById('mat-bgimg').value = "";
        document.getElementById('btn-borrar-materia').style.display = "none";
      }
    }
    function cerrarMateriaEditor(){
      document.getElementById('materia-modal').style.display = "none";
    }
    function guardarMateria(e){
      e.preventDefault();
      let idx = document.getElementById('materia-idx').value;
      let anio = parseInt(document.getElementById('mat-anio').value);
      let correlativas = document.getElementById('mat-correlativas').value.split(",").map(s=>s.trim()).filter(Boolean);
      let mat = [
        anio,
        document.getElementById('mat-codigo').value.trim(),
        document.getElementById('mat-nombre').value.trim(),
        parseInt(document.getElementById('mat-creditos').value),
        document.getElementById('mat-categoria').value,
        correlativas,
        document.getElementById('mat-bgimg').value.trim()
      ];
      let matsEnAnio = materias.filter(m=>m[0]===anio);
      if (idx === "" && matsEnAnio.length >= 10) {
        alert("No puedes agregar más de 10 materias en este año.");
        return;
      }
      if(idx!==""){
        materias[idx]=mat;
      }else{
        materias.push(mat);
      }
      cerrarMateriaEditor();
      guardarYActualizar();
    }
    function borrarMateria(){
      let idx = document.getElementById('materia-idx').value;
      if(confirm("¿Eliminar esta materia?")){
        let cod = materias[idx][1];
        materias.splice(idx,1);
        delete aprobadas[cod];
        guardarYActualizar();
        cerrarMateriaEditor();
      }
    }
    function agregarMateriaGeneral() {
      let anio = prompt("¿A qué año quieres agregar la materia? (1-"+anios.length+"):");
      anio = parseInt(anio);
      if (!anio || anio<1 || anio>anios.length) return;
      abrirMateriaEditor(null, anio);
    }

    // --- MODAL DE CATEGORIAS ---
    function abrirCategoriaEditor(){
      document.getElementById('categoria-modal').style.display = "";
      renderCategoriasEditor();
    }
    function cerrarCategoriaEditor(){
      document.getElementById('categoria-modal').style.display = "none";
    }
    function renderCategoriasEditor() {
      const container = document.getElementById('categorias-editor');
      container.innerHTML = '<h2>Categorías</h2>';
      Object.keys(categorias).forEach(cat => {
        const wrapper = document.createElement('div');
        wrapper.style.marginBottom = "10px";
        wrapper.style.display = "flex";
        wrapper.style.alignItems = "center";
        const colorInput = document.createElement('input');
        colorInput.type = "color";
        colorInput.value = categorias[cat];
        colorInput.style.marginRight = "10px";
        colorInput.oninput = (e) => {
          categorias[cat] = e.target.value;
          guardarYActualizar();
        };
        const nameInput = document.createElement('input');
        nameInput.type = "text";
        nameInput.value = cat;
        nameInput.style.marginRight = "10px";
        nameInput.onchange = (e) => {
          const nuevo = e.target.value.trim();
          if (nuevo && nuevo !== cat && !(nuevo in categorias)) {
            categorias[nuevo] = categorias[cat];
            delete categorias[cat];
            materias.forEach(m => { if (m[4] === cat) m[4] = nuevo; });
            renderCategoriasEditor();
            guardarYActualizar();
          }
        };
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "Eliminar";
        deleteBtn.style.marginLeft = "10px";
        deleteBtn.onclick = () => {
          if (confirm("¿Eliminar la categoría '" + cat + "'? Las materias que la usen quedarán grises.")) {
            delete categorias[cat];
            renderCategoriasEditor();
            guardarYActualizar();
          }
        };
        wrapper.appendChild(colorInput);
        wrapper.appendChild(nameInput);
        wrapper.appendChild(deleteBtn);
        container.appendChild(wrapper);
      });
      const addBtn = document.createElement('button');
      addBtn.textContent = "Añadir nueva categoría";
      addBtn.onclick = () => {
        const nombre = prompt("Nombre de la nueva categoría:");
        if (nombre && !(nombre in categorias)) {
          const color = prompt("Color en formato HEX (ej: #aabbcc):", "#ffffff");
          categorias[nombre] = color || "#ffffff";
          renderCategoriasEditor();
          guardarYActualizar();
        }
      };
      container.appendChild(addBtn);
      const closeBtn = document.createElement('button');
      closeBtn.textContent = "Cerrar";
      closeBtn.style.marginLeft = "20px";
      closeBtn.onclick = cerrarCategoriaEditor;
      container.appendChild(closeBtn);
    }
    function agregarAnio() {
      const nombre = prompt("Nombre del nuevo año:", "Año " + (anios.length + 1));
      if (nombre) {
        anios.push(nombre);
        guardarYActualizar();
      }
    }

    // TITULO editable
    function editarTitulo() {
      document.getElementById('titulo-malla').style.display = 'none';
      var input = document.getElementById('titulo-input');
      input.value = document.getElementById('titulo-malla').textContent;
      input.style.display = '';
      input.focus();
    }
    document.getElementById('titulo-input').addEventListener('blur', function() {
      document.getElementById('titulo-malla').textContent = this.value || "Malla Curricular";
      this.style.display = 'none';
      document.getElementById('titulo-malla').style.display = '';
      guardarYActualizar();
    });
    document.getElementById('titulo-input').addEventListener('keydown', function(e){
      if(e.key==="Enter"||e.key==="Escape") this.blur();
    });

    // FONDO: URL o archivo
    function aplicarFondo() {
      let url = document.getElementById('bg-url').value.trim();
      let file = document.getElementById('bg-file').files[0];
      if (file) {
        let reader = new FileReader();
        reader.onload = function(e) {
          document.body.style.backgroundImage = `url('${e.target.result}')`;
          localStorage.setItem('malla_bg_url', `url('${e.target.result}')`);
        };
        reader.readAsDataURL(file);
      } else if (url) {
        document.body.style.backgroundImage = `url('${url}')`;
        localStorage.setItem('malla_bg_url', `url('${url}')`);
      }
    }
    function quitarFondo() {
      document.body.style.backgroundImage = '';
      document.getElementById('bg-url').value = '';
      document.getElementById('bg-file').value = '';
      localStorage.removeItem('malla_bg_url');
    }

    window.onload = cargarEstado;
    window.onclick = function(e){
      if(e.target.classList && e.target.classList.contains("editor-modal")){
        cerrarMateriaEditor();
        cerrarCategoriaEditor();
      }
    }
  </script>
</body>
</html>
